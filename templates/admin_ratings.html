<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Ratings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}" />
</head>
<body>
  <header class="admin-header">
    <div class="header-content">
      <h1>Ratings</h1>
      <p>All visitor ratings across bookings</p>
    </div>
    <div class="admin-nav">
      <a href="{{ url_for('admin_dashboard') }}" class="nav-link">Dashboard</a>
      <a href="{{ url_for('admin_logout') }}" class="nav-link">Logout</a>
    </div>
  </header>

  <main class="dashboard">
    <div class="page-header">
      <div class="toolbar">
        <input id="qMuseum" class="search" placeholder="Filter by museum..." />
        <input id="qEmail" class="search" placeholder="Filter by email..." />
        <input id="qTicket" class="search" placeholder="Filter by ticket id..." />
      </div>
      <div>
        <select id="perPage" class="search" style="min-width:auto;">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>

    <div id="ratingsList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px;"></div>
    <div class="pagination">
      <button id="prevBtn" class="btn btn-light">Prev</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" class="btn btn-light">Next</button>
    </div>
  </main>

  <script>
    let page = 1;
    let totalPages = 1;

    async function fetchRatings() {
      const perPage = document.getElementById('perPage').value;
      const res = await fetch(`/api/admin/ratings?page=${page}&per_page=${perPage}`);
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.items || []);
      totalPages = data.total_pages || 1;

      // client-side basic filters
      const qMuseum = document.getElementById('qMuseum').value.trim().toLowerCase();
      const qEmail = document.getElementById('qEmail').value.trim().toLowerCase();
      const qTicket = document.getElementById('qTicket').value.trim().toLowerCase();

      const filtered = items.filter(r => {
        const m = (r.Museum || '').toLowerCase();
        const e = (r.VisitorEmail || '').toLowerCase();
        const t = (r.TicketID || '').toLowerCase();
        return (!qMuseum || m.includes(qMuseum)) && (!qEmail || e.includes(qEmail)) && (!qTicket || t.includes(qTicket));
      });

      renderList(filtered);
      document.getElementById('pageInfo').textContent = `Page ${data.page || page} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = (data.page || page) <= 1;
      document.getElementById('nextBtn').disabled = (data.page || page) >= totalPages;
    }

    function renderList(items) {
      const list = document.getElementById('ratingsList');
      if (!items.length) {
        list.innerHTML = '<div class="admin-card">No ratings found.</div>';
        return;
      }
      list.innerHTML = items.map(r => {
        const rating = parseInt(r.Rating) || 0;
        const stars = '★'.repeat(Math.max(0, Math.min(5, rating))) + '☆'.repeat(Math.max(0, 5 - rating));
        const date = r.Date || '-';
        const time = r.Time || '-';
        const name = r.VisitorName || '-';
        const email = r.VisitorEmail || '-';
        return `
          <div class="admin-card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
              <strong>${r.Museum || '-'}</strong>
              <span style="color:#f59e0b; font-size:18px;">${stars}</span>
            </div>
            <div style="color:#6b7280; font-size:12px; display:flex; gap:10px; margin-top:4px;">
              <span>Ticket: ${r.TicketID || '-'}</span>
              <span>${date} ${time}</span>
              <span>${name}</span>
              <span>${email}</span>
            </div>
            ${r.Review ? `<div style="margin-top:6px; font-size:14px;">${r.Review}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    document.getElementById('prevBtn').addEventListener('click', () => { if (page > 1) { page--; fetchRatings(); } });
    document.getElementById('nextBtn').addEventListener('click', () => { if (page < totalPages) { page++; fetchRatings(); } });
    document.getElementById('perPage').addEventListener('change', () => { page = 1; fetchRatings(); });
    document.getElementById('qMuseum').addEventListener('input', () => { fetchRatings(); });
    document.getElementById('qEmail').addEventListener('input', () => { fetchRatings(); });
    document.getElementById('qTicket').addEventListener('input', () => { fetchRatings(); });

    fetchRatings();
  </script>
</body>
</html>
